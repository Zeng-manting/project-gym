# 健身房管理系统 V1.0 数据库设计说明

## 表结构总览

| 表名 | 用途 | 核心字段 | 索引设计 | 关联关系 |
|------|------|----------|----------|----------|
| card_type | 卡类型字典 | type_name, type_code, days_valid, times_valid, price_amount | idx_type_code, idx_deleted_sort | 被member表关联 |
| sys_dict | 系统字典 | dict_type, dict_code, dict_name, dict_value | uk_type_code, idx_dict_type | 独立字典表 |
| admin | 管理员 | username, password, real_name, email, phone, status | idx_username, idx_email, idx_phone, idx_status_deleted | 独立表 |
| coach | 教练 | username, password, real_name, email, phone, specialty, status | idx_username, idx_email, idx_phone, idx_status_deleted | 独立表 |
| member | 会员 | username, card_no, balance_amount, card_type_id, card_end_date, status | idx_username, idx_email, idx_phone, idx_card_no, idx_card_type, idx_status_enddate | 关联card_type表 |
| course | 课程 | course_name, coach_id, course_date, start_time, end_time, max_persons, price_amount, status | idx_coach_id, idx_course_date, idx_status_date, idx_current_max | 关联coach表 |
| course_enroll | 课程报名 | member_id, course_id, enroll_time, status, check_in_time | uk_member_course, idx_member_id, idx_course_id, idx_status | 关联member和course表 |
| recharge | 充值记录 | member_id, recharge_amount, pay_method, pay_status, transaction_no, admin_id | idx_member_id, idx_pay_status, idx_transaction_no, idx_admin_id | 关联member和admin表 |
| announcement | 公告 | title, content, priority, publish_time, expire_time, publisher_id, status | idx_priority, idx_publish_time, idx_status_time, idx_publisher | 关联admin/coach表 |
| card_renewal | 续卡记录 | member_id, old_card_type_id, new_card_type_id, renewal_amount, new_end_date, admin_id | idx_member_id, idx_admin_id, idx_create_time | 关联member, card_type和admin表 |

## 核心字段说明

### 金额字段
- 所有金额字段统一使用`xxx_amount`命名，单位为分（人民币最小单位）
- 例如：`price_amount`, `balance_amount`, `recharge_amount`, `refund_amount`

### 状态字段
- 所有状态字段使用`SMALLINT`类型，并给出明确的枚举注释
- 状态值从1开始，0保留为特殊用途
- 常用状态：1-正常/有效/启用，2-禁用/无效，3-删除/过期

### 时间字段
- 统一使用`DATETIME`类型存储时间
- 标准字段：`create_time`, `update_time`, `deleted`
- 业务时间字段明确注释用途

### 索引设计原则
1. **唯一索引**：用户名、邮箱、手机号等唯一性字段
2. **外键索引**：逻辑外键字段必须建立索引
3. **业务索引**：根据查询场景建立联合索引
4. **覆盖索引**：常用查询字段组合建立覆盖索引
5. **逻辑删除**：所有查询都带deleted条件，索引中包含deleted字段

## 关键业务规则

### 会员余额管理
- 余额字段在`member.balance_amount`中实时更新
- 充值记录只插入`recharge`表，不直接更新余额
- 余额更新通过业务代码保证一致性
- 支持部分退款，退款金额记录在`course_enroll.refund_amount`

### 卡有效期计算
- 开卡日期：`member.card_start_date`
- 到期日期：`member.card_end_date` = 开卡日期 + card_type.days_valid
- 次卡剩余次数：`member.card_times`
- 到期检查通过`member.card_end_date`和当前日期比较

### 课程报名逻辑
- 报名人数控制通过`course.current_persons < course.max_persons`
- 报名状态管理在`course_enroll.status`
- 支持取消报名，状态变为4（已取消）
- 签到功能更新`course_enroll.check_in_time`和状态为2（已签到）

### 充值审核流程
- 会员提交充值申请 → 插入`recharge`表（pay_status=1待支付）
- 管理员审核 → 更新`recharge`表（pay_status=2已支付，admin_id, audit_time）
- 系统更新会员余额 → 更新`member.balance_amount`
- 支持退款 → 更新`recharge`表（pay_status=3已退款）

## 性能优化设计

### 索引优化
1. **覆盖索引**：所有常用查询都通过索引完成，避免全表扫描
2. **联合索引**：根据where条件顺序建立联合索引，提高查询效率
3. **前缀索引**：对长文本字段使用前缀索引
4. **索引选择性**：高选择性字段放在联合索引前面

### 查询优化
1. **分页优化**：使用ID范围分页，避免OFFSET性能问题
2. **日期范围查询**：使用索引覆盖的日期字段
3. **状态过滤**：所有查询都带状态索引
4. **逻辑删除**：所有业务查询都带deleted=0条件

## 数据一致性保证

### 事务设计
1. **充值审核**：更新recharge表 + 更新member余额在同一个事务
2. **课程报名**：检查余额 + 扣减余额 + 增加报名人数在同一个事务
3. **续卡操作**：插入续卡记录 + 更新会员卡信息在同一个事务

### 并发控制
1. **乐观锁**：通过版本号或时间戳控制并发更新
2. **分布式锁**：对关键业务操作使用Redis分布式锁
3. **唯一约束**：通过唯一索引防止重复数据

## 扩展性设计

### 字典表扩展
- `sys_dict`表支持无限扩展字典类型
- 通过`dict_type`字段区分不同业务字典
- 支持排序和状态管理

### 公告系统扩展
- 支持按优先级展示
- 支持有效期控制
- 支持发布者类型扩展（后续可扩展更多角色）

### 支付扩展
- `recharge.pay_method`支持多种支付方式扩展
- `recharge.transaction_no`支持第三方交易号记录
- 支付状态管理完整生命周期
